sudo: required
dist: trusty
services: docker
language: python
python: 3.5
cache:
  timeout: 600

cache:
  directories:
    - $HOME/Library/Caches/Homebrew

notifications:
  webhooks:
    urls:
      - secure: "0sb4pr3j+oKITR6A3dfrX7+ZE3kJ73hmDMaHgzM6wuQ+KiXMlGcFWEkWCOPUkF/oYeTRlTct27oXj+RKkOaebF6sZ24SwCyKq/zpoawIjmDNi1IqIyqh90UZ1F0FpV+SZL93ge6L3+W5a+ruCDDrlBStAUUH9s1tuWft2LTxewGCdrOm/ZYtEdPGcQ5qjtXP7ZMikkJ7eYIppFfmM9oAL3eiq9FoVxX1X+S4BdIBG8IrZLmiTkvWe7cTZItzAcMzEco2+TnqjUgJ6lV0Ud0lr7iP5WcW2n34MDirQgA2YfJMPMqRUlb3wZ+o/cUrW/G3Qri4e9U9vidgH1G/cfNiER6YKHNt9izWvF7RImBs7wS+Zcmpq90ADXdCDKlCH9YIicngf8vJ7dSXGn+j1Aoba5yvImPK4eueay7SJFfWR29ClsHQgkhfXBCHaO2yHMTbo5ondCP5TcQVkqeuZvKpEG8IsFYQu9v4O9qzePcKF65SimIxIlvf76J8eHJtn+VguV8Dxa+5ixNNJalLcDlwWdlJm26A729fZ4Pl+JWdpTcn72yzRoCPXYh1L0oZzZDx8fp1W0RuvDW0sVwVhod4O63NtMbW58L9g5LjzeQ7EFlUlEDR8v+x8oCowir7T9NGAnGdO/gvVd3rJODf9olNyqZ53nHHRwFc+wtF8lKqDy4="

jobs:
  include:
  - stage: build+test
    os: linux
    env:
    - CMAKE_ARGS='-DBUILD_TESTS=ON'
    - TEST='TRUE'
    - CC_VER="5"
    - PLATFORM='xenial'
    script: "./travis/build.sh"

  - stage: build+test
    os: linux
    env:
    - PLATFORM='xenial-emscripten'
    script: "./travis/build.sh"

  - stage: publish
    if: tag =~ ^v
    os: linux
    env:
    - PLATFORM='xenial-emscripten'
    script:
    - "./travis/build.sh"
    - "./travis/patch_npmversion.sh"

    before_deploy: npm version

    deploy:
      provider: npm
      skip_cleanup: true
      email: "info@theqrl.org"
      api_key: $NPM_API_KEY
      on:
        tags: true
        all_branches: true
